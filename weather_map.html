<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Weather Map</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.2.1/mapbox-gl.css' rel='stylesheet' />
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.4.1/mapbox-gl-geocoder.css' type='text/css' />
    <style>
        #card-body {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 1em;
            margin-bottom: 1em;
        }
        .custom-select {
            width: 250px;
        }
        .main-nav {
            background-color: #3b5998;
            color: white;
        }
        #map {
            border: #3b5998 solid 10px;
            display: flex;
            margin: auto;
        }
        .card {
            border: black 2px dotted;
        }
    </style>
</head>
<body>
    <nav class="main-nav navbar">
        <span class="navbar-brand mb-0 h1">Weather Application</span>
        <select class="custom-select" id="weather-forecast">
            <option value="3">3 Days Forecast</option>
            <option value="5">5 Days Forecast</option>
            <option value="7">7 Days Forecast</option>
        </select>
        <p class="m-2" id="cityState"></p>
        <button id="toggle-map">Show Map</button>
    </nav>

    <div id="card-body"></div>

    <div id='map' style='width: 50%; height: 350px;'></div>

    <pre id='coordinates' class='coordinates'></pre>


<script src="js/jquery-2.2.4.js"></script>
    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.4.1/mapbox-gl-geocoder.min.js'></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
<script src="js/keys.js"></script>
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.2.1/mapbox-gl.js'></script>
    <script src="js/mapbox-utils.js"></script>




<script>
    $(document).ready(function() {

       $('#toggle-map').click(function() {
          $('#map').toggle();
       });
        var longitude = "-98.4936";

        var latitude = "29.4241";

        var lngLat = "";

        //Creates Map and Centers it on San Antonio
        mapboxgl.accessToken = mapboxToken;
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v9',
            zoom: 9,
            center: [-98.4936, 29.4241]
        }); //mapboxgl object

        var marker = new mapboxgl.Marker({
            draggable: true
        }) //marker object
            .setLngLat([-98.4936, 29.4241])
            .addTo(map);

        map.addControl(new MapboxGeocoder({
            accessToken: mapboxgl.accessToken,
            // mapboxgl: mapboxgl
        }));
        var cityState = "";

        map.on('moveend', function() {
            lngLat = map.getCenter();
            console.log(lngLat);
            marker.setLngLat(lngLat);
            longitude = lngLat.lng;
            latitude = lngLat.lat;
            updateWeatherCard();
            reverseGeocode();
        });



        // $('#cityState').text('San Antonio, Texas');

        function reverseGeocode() {
            $.get('https://api.mapbox.com/geocoding/v5/mapbox.places/' + longitude + "," + latitude + ".json?access_token=" + mapboxToken).done(function(data) {
                cityState = data.features[1].place_name;
                $('#cityState').text(cityState);
            })//get()
        } //reverseGeocode()

        reverseGeocode();

        //WEATHER OBJECTS

        var weatherObjects = [
            {
                condition: "clear-day",
                url: 'icon/sun.svg'

            }, {
                condition: "clear-night",
                url: 'icon/moon-full.svg'
            }, {
                condition: "rain",
                url: 'icon/cloud-rain.svg',
                gif: 'gif/rain.gif'
            }, {
                condition: "snow",
                url: 'icon/cloud-snow'

            }, {
                condition: "sleet",
                url: 'icon/cloud-hail.svg'
            }, {
                condition: "wind",
                url: 'icon/wind.svg'
            }, {
                condition: "fog",
                url: 'icon/cloud-fog.svg'
            }, {
                condition: "cloudy",
                url: 'icon/cloud.svg'
            }, {
                condition: "partly-cloudy-day",
                url: 'icon/cloud-sun.svg'
            }, {
                condition: "partly-cloudy-night",
                url: 'icon/cloud-moon.svg'
            }
        ];

        //---------------------------------------------------------------------------------------------------------

            //UPDATES WEATHER CARDS

            function updateWeatherCard() {

                var html = "";

                //USER SUBMITTED DATA THROUGH SELECT INPUT

                    var days = $('#weather-forecast').children('option:selected').val();
                    days = days -1;
                    console.log(days);

                $.get("https://cors-anywhere.herokuapp.com/https://api.darksky.net/forecast/" + darkSkyKey + "/" + latitude + ", " + longitude).done(function(data) {


                    // console.log(data);

                    for(var i = 0; i <= days; i++) {

                            var weatherCondition = "";

                            //Stores the icon string value into this variable

                            var weatherIcon = data.daily.data[i].icon;

                            //Cycles through the weatherObjects array

                            weatherObjects.forEach(function(element) {

                                //check to see if the icon string value is found in the weatherObjects array

                                if(weatherIcon === element.condition) {

                                    //Puts the url for the correct image into the weatherCondition variable

                                    weatherCondition += element.url;

                                } //if

                            }); //forEach()

                            //Converts windSpeed from meters per second to miles per hour

                            var windSpeed = (data.daily.data[i].windSpeed) * 2.237;

                            //Converts time property value to readable time

                            var dateObject = new Date((data.daily.data[i].time) * 1000);

                            dateObject = dateObject.toDateString();

                            html += "<div class=\"m-1 card\" style=\"width: 10rem;\">";

                            html += "<div class=\"card-body\">";

                            html += "<h5 class=\"card-title\">" + dateObject + "</h5>";

                            html += "<h6 class=\"card-subtitle mb-2 text-muted\">" + data.daily.data[i].apparentTemperatureHigh + " / " + data.daily.data[i].apparentTemperatureLow + "&#8457;" + "</h6>";

                            html += "<img src=" + weatherCondition + ">";

                            html += "<p class=\"card-text\">" + data.daily.data[i].summary + "</p>";

                            html += "<p class=\"card-text\">" + windSpeed.toFixed(2) + " mph" + "</p>";

                            html += "</div>";

                            html += "</div>";

                    } //if

                    $('#card-body').html(html);

                }); //get()

            } //updateWeatherCard()

            updateWeatherCard();

            $('.form-control').change(updateWeatherCard());
            //------------------------------------------------------------------------------------------------------
        function onDragEnd() {
            lngLat = marker.getLngLat();
            longitude = lngLat.lng.toString();
            latitude = lngLat.lat.toString();
            updateWeatherCard();
            console.log(reverseGeocode());
        } //onDragEnd()

        marker.on('dragend', onDragEnd);


    });//ready()
</script>
</body>
</html>